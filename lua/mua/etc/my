#!/usr/bin/env bash

# misc convenient shortcuts

My=$(cd $( dirname "${BASH_SOURCE[0]}" ) && pwd )/..
chmod +x $My/etc/my
mkdir -p $My/src $My/docs

test1() { lua -e "x=require('${1%.*}').tests()"; }

alias ls="ls -G"
alias gp="git add *; git commit -am saving; git push; git status"
alias my="$My/etc/my "
alias ok="test1"
alias oks="my -t"
alias okspy="(rerun '$My/etc/my -t')"

docs() {
  (cd $My/src; pycco -d $My/docs *.lua)
  markdown $My/README.md > $My/docs/index.html
  cp $My/etc/pycco.css $My/docs
}

art() { cat<<'EOF'
  oO)-.                       .-(Oo
 /__  _\                     /_  __\
 \  \(  |     ()~()         |  )/  /
  \__|\ |    (-___-)        | /|__/
  '  '--'    ==`-'==        '--'  '

     .--.
    |o_o |
    |:_/ |
   //   \ \
  (|     | )
 /'\_   _/`\
 \___)=(___/

                                   .::!!!!!!!:.
 .!!!!!:.                        .:!!!!!!!!!!!!
 ~~~~!!!!!!.                 .:!!!!!!!!!UWWW$$$
     :$$NWX!!:           .:!!!!!!XUWW$$$$$$$$$P
     $$$$$##WX!:      .<!!!!UW$$$$"  $$$$$$$$#
     $$$$$  $$$UX   :!!UW$$$$$$$$$   4$$$$$*
     ^$$$B  $$$$\     $$$$$$$$$$$$   d$$R"
       "*$bd$$$$      '*$$$$$$$$$$$o+#"
            """"          """""""

         /'._     _,
         \   ;__.'  }
     (`-._;-" _.--.}'
     /_'    /`    _}     _.--"""-.
       `.   \_._.;     .'         \
         '-.__ /      /            |
 jgs      _/  `\      \            /
         ^`   ^`       '._       .'
                          `"""""``

      _.---._..-""""""-.
   .-" o   -.           `.
   `._     -'             \
     _`";`                 |  
    '-'__\  \     _.-'     /__
      '-'---'--'``\__, _.-'--""-.
 jgs               (.-'        ,-`

      ,____________,
      .'          '.
     /~~~~^~~~^~^~~~\
    /      _    /||  \
   ;      ( }   \||D  ;
   |    | /\__,=[_]   |
   ;  ( |_\_  |---|   ;
    \  )|  |/ |   |  /
 jgs '. |  /_ |   |.'
      '------------'

          '\                   .  . 
            \              .         ' .
           O>>         .                 'o
            \       . 
            /\    .  
           / /  .'                           
 ^^^^^jgs^^^^^^^`^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

   __
    /
 .-/-.
 |'-'|
 |   |
 |   |   .-""""-.
 \___/  /' .  '. \   \|/\//
       (`-..:...-')  |`""`|
        ;-......-;   |    |
   jgs   '------'    \____/

                                  .
     .              .   .'.     \   /
   \   /      .'. .' '.'   '  -=  o  =-
 -=  o  =-  .'   '              /   \
   /   \                          '
     '

                       *       +
   *     '                  |
     ()    .-.,-"``"-.    - o -
           '=/_       \     |
        *   |::'=._    ;      '
   '         \::.  `=./`,   '
     +    .   '-::..-'``'    *
 jgs   O    *     .       +  .
          *     .       +

           ___
          /`  _\    
          |  / 0|--.  
     -   / \_|0`/ \.`'._/)
 - ~ -^_| /-_~ ^- ~_` - -~_
 -  ~  -| |   - ~ -  ~  -
 jgs     \ \, ~   -   ~  
          \_|

  , ; ,   .-'"""'-.   , ; ,
  \\|/  .'         '.  \|//
   \-;-/  ()     ()  \-;-/
   // ;               ; \\
  //__; :.         .; ;__\\
 `-----\'.'-.....-'.'/-----'
        '.'.-.-,_.'.'
 jgs      '(  (..-'
            '-'

                _ _       \ \
     .-"""""-. / \_> /\    |/
    /         \.'`  `',.--//
  -(          I       I  @@\
    \         /'.____.'\___|
     '-.....-' __/ | \   (`)
 jgs          /   /  /
                  \  \

       _____
      /     \______
     |  .-""-.     |
     | /      \    |
     | \      /    |
     |  '-..-;\    |
 jgs |________\\___|
                  \|
EOF
}
redgreen() { gawk '
     /^---/ {        $0="\033[01;36m"$0"\033[0m" }
     /FAIL/ { bad++; $NF="\033[31m"$NF"\033[0m" }
     /PASS/ {        $NF="\033[32m"$NF"\033[0m" }
            { print  $0                 }
     END    { exit bad!=0 }'
}

if [ "$1" == "-t" ]; then
  date +"%r"
  echo -e "\e[1m\e[30m\e[40m"
  art | gawk '
   BEGIN {srand('$RANDOM'); RS="";FS=""}
         {N[rand()] = $0}
   END   {for(i in N) { print N[i]; break}}'
  echo -e "\033[0m" 
  cd $My/src
  for f in *.lua; do
    echo "------------- $f"
    test1 $f
  done | redgreen
  exit $?
fi

