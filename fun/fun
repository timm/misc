#!/usr/bin/env bash
# vim: filetype=sh ts=2 sw=2 sts=2  et :

What=fun

parse() { gawk '
  /^@include/              { print "CODE "$0; next }
  /^(func|BEGIN|END).*}$/  { print "CODE "$0; next }
  /^(func|BEGIN|END)/,/^}/ { print "CODE "$0; next }
                           { print "DOC " $0} '
}
doc() {  gawk  -vhead=$1 ' 
  sub(/^CODE /,"") { if(!Code) print "```awk"; 
                     Code=1; 
                     print sprintf("%4s.  ",++N) $0; 
                     next }
  sub(/^DOC /,"")  { if( Code) print "```";    
                     Code=0 }
  BEGIN            { print  "---\ntitle: " head "\n---\n\n# " head  }
  NR < 3           { next }
                   { print }
  END              { if (Code) print "```";  } '
}
gen() { gawk ' 
  function prep(s) {
    print gensub(/\.([^0-9])([a-zA-Z0-9_]*)/, 
                  "[\"\\1\\2\"]","g",s) } 
   
  sub(/^DOC /,"#")         { print; next }
                           { gsub(/(CODE |[ \t]*$)/,"")   }
  /^@include/              { prep($0); next }
  /^(func|BEGIN|END).*}$/  { prep($0); next }
  /^(func|BEGIN|END)/,/^}/ { prep($0); next }
                           { print "# " $0  } '
}


d="$HOME/tmp/$What"
mkdir -p $d
header="^#!/usr/bin/env.*$What"
for f in *
do
  if [ -f "$f" ]; then
    if head -1 $f | grep $header > /dev/null; then
      out=$d/$(basename $f ".fun")
      #echo "$f  ==>  $out.awk $out.md"
      if [ "$f" -nt "${out}.awk" ]; then 
        cat $f | parse | gen     > ${out}.awk; 
        cat $f | parse | doc  $f > ${out}.md; fi
  fi fi
done

g=$(basename $1)
shift
AWKPATH=".:$d:$AWKPATH" gawk -v THIS="$g" -f $d/$g $*
