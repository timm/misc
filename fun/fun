#!/usr/bin/env bash
# vim: filetype=sh ts=2 sw=2 sts=2  et :

My=$(git rev-parse --show-toplevel)
MySrc=$My/fun/src
MyTest=$My/fun/test

Ext=fun
Doc=$HOME/opt/$Ext/docs
Lib=$HOME/opt/$Ext/lib
Bin=$HOME/opt/$Ext/bin
PATH="$PATH:$Bin"

mkdir -p $Doc $Lib $Bin $MySrc $MyTest

parse() { gawk '
  /^@include/              { print "CODE "$0; next }
  /^(func|BEGIN|END).*}$/  { print "CODE "$0; next }
  /^(func|BEGIN|END)/,/^}/ { print "CODE "$0; next }
                           { print "DOC " $0} '
}
doc() {  gawk  -vhead="${1}" -vtop="$(buttons)" ' 
  sub(/^CODE /,"") { if(!Code) print "```awk"; 
                     Code=1; 
                     print sprintf("%4s.  ",++N) $0; 
                     next }
  sub(/^DOC /,"")  { if( Code) print "```";    
                     Code=0 }
  BEGIN            { print  "---\ntitle: " head "\n---\n\n"
                     print  top   "<br>\n\n# " head "\n\n" }
  NR < 3           { next }
                   { print }
  END              { if (Code) print "```";  } '
}
gen() { gawk ' 
  function prep(s) {
    print gensub(/\.([^0-9])([a-zA-Z0-9_]*)/, 
                  "[\"\\1\\2\"]","g",s) } 
  sub(/^DOC /,"#")         { print; next }
                           { gsub(/(CODE |[ \t]*$)/,"")   }
  /^@include/              { prep($0); next }
  /^(func|BEGIN|END).*}$/  { prep($0); next }
  /^(func|BEGIN|END)/,/^}/ { prep($0); next }
                           { print "# " $0  } '
}

buttons() { 
  b0='</button>'
  b1='<button class="button button1">'
  b2='<button class="button button2">'
  cat <<EOF
  $b1 <a href="/fun/index">home</a> $b0
  $b2 <a href="/fun/INSTALL">install</a> $b0
  $b1 <a href="/fun/ABOUT">doc</a> $b0
  $b2 <a href="http://github.com/timm/fun/issues">discuss</a> $b0
  $b1 <a href="/fun/LICENSE">license</a> $b0
EOF
}
exe() {
 cat<<EOF
 if [ ! -t 0 ]; then
   cat - | AWKPATH="$Lib:.:$AWKPATH" gawk -f ${Lib}/${1}.awk \$*
 else
   AWKPATH="$Lib:.:$AWKPATH" gawk -f ${Lib}/${1}.awk \$*
 fi
EOF
}
awkfiles() {
  for f in $MySrc/*.awk $MyTest/*.awk; do
    stem=$(basename $f ".awk")
    if [ "$f" -nt "${Lib}/${stem}.awk" ]; then 
      cp $f ${Lib}/${stem}.awk; fi
    if [ "$f" -nt "${Bin}/${stem}" ]; then 
      exe $stem > ${Bin}/${stem};  
      chmod +x ${Bin}/${stem}; fi 
  done
}
funfiles() {
  for f in $MySrc/*.fun $MyTest/*.fun; do
    stem=$(basename $f ".fun")
    if [ "$f" -nt "${Lib}/${stem}.awk" ]; then 
      cat $f | parse | gen > ${Lib}/${stem}.awk ; fi
    if [ "$f" -nt "${Doc}/${stem}.md" ]; then 
      cat $f | parse | doc  ${stem}.fun > ${Doc}/${stem}.md; fi
    if [ "$f" -nt "${Bin}/${stem}" ]; then 
      exe $stem > ${Bin}/${stem};  
      chmod +x ${Bin}/${stem}; fi
  done
}
mdfiles() {
  for f in $MySrc/*.md; do
    stem=$(basename $f ".md")
    if [ "$f" -nt "${Doc}/${stem}.md" ]; then 
      cat $f | doc  ${stem}.fun > ${Doc}/${stem}.md; fi
  done
} 
awkfiles
funfiles
mdfiles
g=$(basename $1 ".fun")
shift
if [ -n "$1" ]; then
  if [ ! -t 0 ]; then
   (cat - | $g $*)
  else
   $g $* 
  fi
fi
exit 0
