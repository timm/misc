<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>sendemail-validate.sample</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div class='section'>
    <div class='docs'><h1>sendemail-validate.sample</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span></span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <p>An example hook script to validate a patch (and/or patch series) before
sending it via email.</p>
<p>The hook should exit with non-zero status after issuing an appropriate
message if it wants to prevent the email(s) from being sent.</p>
<p>To enable this hook, rename this file to &ldquo;sendemail-validate&rdquo;.</p>
<p>By default, it will only check that the patch(es) can be applied on top of
the default upstream branch without conflicts in a secondary worktree. After
validation (successful or not) of the last patch of a series, the worktree
will be deleted.</p>
<p>The following config variables can be set to change the default remote and
remote ref that are used to apply the patches against:</p>
<p>sendemail.validateRemote (default: origin)
  sendemail.validateRemoteRef (default: HEAD)</p>
<p>Replace the TODO placeholders with appropriate checks according to your
needs.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>validate_cover_letter<span class="w"> </span><span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">	</span><span class="nv">file</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      <p>TODO: Replace with appropriate checks (e.g. spell checking).</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="w">	</span><span class="nb">true</span>
<span class="o">}</span>

validate_patch<span class="w"> </span><span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">	</span><span class="nv">file</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <p>Ensure that the patch applies without conflicts.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="w">	</span>git<span class="w"> </span>am<span class="w"> </span>-3<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$file</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="k">return</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      <p>TODO: Replace with appropriate checks for this patch
(e.g. checkpatch.pl).</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="w">	</span><span class="nb">true</span>
<span class="o">}</span>

validate_series<span class="w"> </span><span class="o">()</span><span class="w"> </span><span class="o">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      <p>TODO: Replace with appropriate checks for the whole series
(e.g. quick build, coding style checks, etc.).</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="w">	</span><span class="nb">true</span>
<span class="o">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      <p>main -------------------------------------------------------------------------</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">if</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$GIT_SENDEMAIL_FILE_COUNTER</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
<span class="k">then</span>
<span class="w">	</span><span class="nv">remote</span><span class="o">=</span><span class="k">$(</span>git<span class="w"> </span>config<span class="w"> </span>--default<span class="w"> </span>origin<span class="w"> </span>--get<span class="w"> </span>sendemail.validateRemote<span class="k">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">	</span><span class="nv">ref</span><span class="o">=</span><span class="k">$(</span>git<span class="w"> </span>config<span class="w"> </span>--default<span class="w"> </span>HEAD<span class="w"> </span>--get<span class="w"> </span>sendemail.validateRemoteRef<span class="k">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">	</span><span class="nv">worktree</span><span class="o">=</span><span class="k">$(</span>mktemp<span class="w"> </span>--tmpdir<span class="w"> </span>-d<span class="w"> </span>sendemail-validate.XXXXXXX<span class="k">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">	</span>git<span class="w"> </span>worktree<span class="w"> </span>add<span class="w"> </span>-fd<span class="w"> </span>--checkout<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$worktree</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;refs/remotes/</span><span class="nv">$remote</span><span class="s2">/</span><span class="nv">$ref</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">	</span>git<span class="w"> </span>config<span class="w"> </span>--replace-all<span class="w"> </span>sendemail.validateWorktree<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$worktree</span><span class="s2">&quot;</span>
<span class="k">else</span>
<span class="w">	</span><span class="nv">worktree</span><span class="o">=</span><span class="k">$(</span>git<span class="w"> </span>config<span class="w"> </span>--get<span class="w"> </span>sendemail.validateWorktree<span class="k">)</span>
<span class="k">fi</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">{</span>
<span class="w">	</span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;sendemail-validate: error: failed to prepare worktree&quot;</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span>
<span class="w">	</span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="o">}</span>

<span class="nb">unset</span><span class="w"> </span>GIT_DIR<span class="w"> </span>GIT_WORK_TREE
<span class="nb">cd</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$worktree</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span>

<span class="k">if</span><span class="w"> </span>grep<span class="w"> </span>-q<span class="w"> </span><span class="s2">&quot;^diff --git &quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="k">then</span>
<span class="w">	</span>validate_patch<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="k">else</span>
<span class="w">	</span>validate_cover_letter<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="k">fi</span><span class="w"> </span><span class="o">&amp;&amp;</span>

<span class="k">if</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$GIT_SENDEMAIL_FILE_COUNTER</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$GIT_SENDEMAIL_FILE_TOTAL</span><span class="s2">&quot;</span>
<span class="k">then</span>
<span class="w">	</span>git<span class="w"> </span>config<span class="w"> </span>--unset-all<span class="w"> </span>sendemail.validateWorktree<span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">	</span><span class="nb">trap</span><span class="w"> </span><span class="s1">&#39;git worktree remove -ff &quot;$worktree&quot;&#39;</span><span class="w"> </span>EXIT<span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">	</span>validate_series
<span class="k">fi</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
