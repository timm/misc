<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>gendocs.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div class='section'>
    <div class='docs'><h1>gendocs.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span></span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <p>This script generates a static documentation web site
by parsing the <code>**/*.asiidoc</code> files from the repository.</p>
<p>Dependencies:
* Python 3
* <code>xdg-open</code> for opening the final result in a web browser.
* <code>antora</code> - a static documentation web site generator,
    https://docs.antora.org/antora/latest</p>
<p>Usage:</p>
<pre><code class="language-console">$ ./contrib/gendocs.py
</code></pre>
<p>After running it should open the generated web site in a browser.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">subprocess</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      <p>Get the script directory.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">script_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <p>Switch to the projects root dir.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">script_dir</span><span class="p">,</span> <span class="s2">&quot;..&quot;</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      <p>Recreating the final output dir to start from scratch.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="s2">&quot;doc_gen&quot;</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s2">&quot;doc_gen&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      <p>Antora fails if the repo contains broken symbolic links.
shutil.rmtree(&ldquo;libexec&rdquo;, ignore_errors=True)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      <p>Canonical Antora paths.
See: https://docs.antora.org/antora/latest/standard-directories.
     https://docs.antora.org/antora/latest/root-module-directory.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s2">&quot;doc_gen/modules/ROOT/images&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s2">&quot;doc_gen/modules/ROOT/pages&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      <p>Put necessary images to the Antora canonical directory.
See: https://docs.antora.org/antora/latest/images-directory.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">for</span> <span class="n">gif_file</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;doc/*.gif&quot;</span><span class="p">):</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">gif_file</span><span class="p">,</span> <span class="s2">&quot;doc_gen/modules/ROOT/images/&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      <p>Fix links according to the Antora specification.
See: https://docs.antora.org/antora/latest/page/xref.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">fix_links</span><span class="p">(</span><span class="n">path</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@dataclass</span>
    <span class="k">class</span> <span class="nc">Link</span><span class="p">:</span>
        <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
        <span class="n">file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
        <span class="n">fragment</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
        <span class="n">title</span><span class="p">:</span> <span class="nb">str</span>

        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">fragment</span><span class="p">,</span> <span class="n">title</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fragment</span> <span class="o">=</span> <span class="n">fragment</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">title</span>

    <span class="k">def</span> <span class="nf">dropwhile</span><span class="p">(</span><span class="n">predicate</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">itertools</span><span class="o">.</span><span class="n">dropwhile</span><span class="p">(</span>
                <span class="n">predicate</span><span class="p">,</span>
                <span class="n">string</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">dropwhileright</span><span class="p">(</span><span class="n">predicate</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="nb">reversed</span><span class="p">(</span>
                <span class="nb">list</span><span class="p">(</span>
                    <span class="n">itertools</span><span class="o">.</span><span class="n">dropwhile</span><span class="p">(</span>
                        <span class="n">predicate</span><span class="p">,</span>
                        <span class="nb">reversed</span><span class="p">(</span><span class="n">string</span><span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">takewhile</span><span class="p">(</span><span class="n">predicate</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">itertools</span><span class="o">.</span><span class="n">takewhile</span><span class="p">(</span>
                <span class="n">predicate</span><span class="p">,</span>
                <span class="n">string</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">untag</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
        <span class="n">no_opening</span> <span class="o">=</span> <span class="n">dropwhile</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="n">string</span><span class="p">)</span>
        <span class="n">no_closing</span> <span class="o">=</span> <span class="n">dropwhileright</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">,</span> <span class="n">no_opening</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">no_closing</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
        <span class="n">untagged</span> <span class="o">=</span> <span class="n">untag</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
        <span class="n">prefix</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="n">untagged</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">title</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">fragment</span> <span class="o">=</span> <span class="n">dropwhile</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span> <span class="o">!=</span> <span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
        <span class="n">fragment</span> <span class="o">=</span> <span class="n">fragment</span> <span class="k">if</span> <span class="n">fragment</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">fragmentless</span> <span class="o">=</span> <span class="n">takewhile</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span> <span class="o">!=</span> <span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
        <span class="n">segments</span> <span class="o">=</span> <span class="n">fragmentless</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="n">path</span><span class="p">,</span> <span class="n">file</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">segments</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">segments</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">fragmentless</span>
            <span class="k">else</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">fragmentless</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">Link</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">fragment</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="n">link</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">path</span> <span class="ow">and</span> <span class="n">link</span><span class="o">.</span><span class="n">file</span> <span class="ow">and</span> <span class="n">link</span><span class="o">.</span><span class="n">fragment</span> <span class="o">==</span> <span class="s2">&quot;#&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;xref:</span><span class="si">{</span><span class="n">link</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">link</span><span class="o">.</span><span class="n">file</span><span class="si">}</span><span class="s2">.adoc[</span><span class="si">{</span><span class="n">link</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2">]&quot;</span>
        <span class="k">elif</span> <span class="n">link</span><span class="o">.</span><span class="n">path</span> <span class="ow">and</span> <span class="n">link</span><span class="o">.</span><span class="n">file</span> <span class="ow">and</span> <span class="n">link</span><span class="o">.</span><span class="n">fragment</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;xref:</span><span class="si">{</span><span class="n">link</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">link</span><span class="o">.</span><span class="n">file</span><span class="si">}</span><span class="s2">.adoc</span><span class="si">{</span><span class="n">link</span><span class="o">.</span><span class="n">fragment</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">link</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2">]&quot;</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">link</span><span class="o">.</span><span class="n">path</span> <span class="ow">and</span> <span class="n">link</span><span class="o">.</span><span class="n">file</span> <span class="ow">and</span> <span class="n">link</span><span class="o">.</span><span class="n">fragment</span> <span class="o">==</span> <span class="s2">&quot;#&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;xref:./</span><span class="si">{</span><span class="n">link</span><span class="o">.</span><span class="n">file</span><span class="si">}</span><span class="s2">.adoc[</span><span class="si">{</span><span class="n">link</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2">]&quot;</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">link</span><span class="o">.</span><span class="n">path</span> <span class="ow">and</span> <span class="n">link</span><span class="o">.</span><span class="n">file</span> <span class="ow">and</span> <span class="n">link</span><span class="o">.</span><span class="n">fragment</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;xref:./</span><span class="si">{</span><span class="n">link</span><span class="o">.</span><span class="n">file</span><span class="si">}</span><span class="s2">.adoc</span><span class="si">{</span><span class="n">link</span><span class="o">.</span><span class="n">fragment</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">link</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2">]&quot;</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">link</span><span class="o">.</span><span class="n">path</span> <span class="ow">and</span> <span class="n">link</span><span class="o">.</span><span class="n">file</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">link</span><span class="o">.</span><span class="n">fragment</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;&lt;</span><span class="si">{</span><span class="n">link</span><span class="o">.</span><span class="n">file</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">link</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2">&gt;&gt;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to render link: </span><span class="si">{</span><span class="n">link</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="n">string</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">parse</span><span class="p">(</span><span class="n">string</span><span class="p">))</span> <span class="k">if</span> <span class="s2">&quot;,&quot;</span> <span class="ow">in</span> <span class="n">string</span> <span class="k">else</span> <span class="n">string</span>

    <span class="n">content</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      <p>Fix image links according the Antora specification.
See: https://docs.antora.org/antora/latest/page/image-resource-id-examples.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;image::doc/&quot;</span><span class="p">,</span> <span class="s2">&quot;image::&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&lt;&lt;[^&gt;]+&gt;&gt;&quot;</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">content</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      <p>A useful documentation page.
Add the <code>.adoc</code> extension to include it into the result.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span>
    <span class="s2">&quot;VIMTOKAK&quot;</span><span class="p">,</span>
    <span class="s2">&quot;doc_gen/modules/ROOT/pages/VIMTOKAK.adoc&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">fix_links</span><span class="p">(</span><span class="s2">&quot;doc_gen/modules/ROOT/pages/VIMTOKAK.adoc&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;**/*.asciidoc&quot;</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      <p>Create directories structure matching the project&rsquo;s original structure.
See: https://docs.antora.org/antora/latest/pages-directory.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">page_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="s2">&quot;doc_gen/modules/ROOT/pages&quot;</span><span class="p">,</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">source</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">page_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      <p>Copy the <code>asciidoc</code> file into the Antora <code>pages</code> directory
with the mandatory <code>.adoc</code> filename extension.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">adoc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">page_dir</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">source</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span> <span class="o">+</span> <span class="s2">&quot;.adoc&quot;</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">adoc</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">source</span> <span class="o">==</span> <span class="s2">&quot;README.asciidoc&quot;</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      <p>Update the filename so it reflects the content.
The filename is used for navigation links.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span>
            <span class="s2">&quot;doc_gen/modules/ROOT/pages/README.adoc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;doc_gen/modules/ROOT/pages/index.adoc&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">adoc</span> <span class="o">=</span> <span class="s2">&quot;doc_gen/modules/ROOT/pages/index.adoc&quot;</span>
    <span class="k">elif</span> <span class="n">source</span> <span class="o">==</span> <span class="s2">&quot;test/README.asciidoc&quot;</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      <p>The file name is used for navigation links.
Update so it reflects the content.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span>
            <span class="s2">&quot;doc_gen/modules/ROOT/pages/test/README.adoc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;doc_gen/modules/ROOT/pages/test/tests.adoc&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">adoc</span> <span class="o">=</span> <span class="s2">&quot;doc_gen/modules/ROOT/pages/test/tests.adoc&quot;</span>
    <span class="n">fix_links</span><span class="p">(</span><span class="n">adoc</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      <p>A navigation file for the sidebar.
See: https://docs.antora.org/antora/latest/navigation/single-list.</p>
<p>TODO: Generate automatically.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">nav_content</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">* xref:index.adoc[Getting Started]</span>
<span class="s2">* xref:doc/pages/commands.adoc[Commands]</span>
<span class="s2">* xref:doc/pages/expansions.adoc[Expansions]</span>
<span class="s2">* xref:doc/pages/execeval.adoc[Exec Eval]</span>
<span class="s2">* xref:doc/pages/scopes.adoc[Scopes]</span>
<span class="s2">* xref:doc/pages/faces.adoc[Faces]</span>
<span class="s2">* xref:doc/pages/buffers.adoc[Buffers]</span>
<span class="s2">* xref:doc/pages/registers.adoc[Registers]</span>
<span class="s2">* xref:doc/pages/mapping.adoc[Mapping]</span>
<span class="s2">* xref:doc/pages/hooks.adoc[Hooks]</span>
<span class="s2">* xref:doc/pages/command-parsing.adoc[Command Parsing]</span>
<span class="s2">* xref:doc/pages/keys.adoc[Keys]</span>
<span class="s2">* xref:doc/pages/regex.adoc[Regex]</span>
<span class="s2">* xref:doc/pages/options.adoc[Options]</span>
<span class="s2">* xref:doc/pages/highlighters.adoc[Highlighters]</span>
<span class="s2">* xref:doc/pages/modes.adoc[Modes]</span>
<span class="s2">* xref:doc/pages/keymap.adoc[KEYMAP]</span>
<span class="s2">* xref:doc/pages/faq.adoc[FAQ]</span>
<span class="s2">* xref:doc/pages/changelog.adoc[Changelog]</span>
<span class="s2">* xref:doc/design.adoc[Design]</span>
<span class="s2">* xref:doc/coding-style.adoc[Coding Style]</span>
<span class="s2">* xref:doc/writing_scripts.adoc[Writing Scripts]</span>
<span class="s2">* xref:doc/json_ui.adoc[JSON UI]</span>
<span class="s2">* xref:doc/autoedit.adoc[Autoedit]</span>
<span class="s2">* xref:doc/interfacing.adoc[Interfacing]</span>
<span class="s2">* xref:rc/tools/lint.adoc[Linting]</span>
<span class="s2">* xref:rc/tools/autorestore.adoc[Autorestore]</span>
<span class="s2">* xref:rc/tools/doc.adoc[Doc]</span>
<span class="s2">* xref:test/tests.adoc[Tests]</span>
<span class="s2">* xref:VIMTOKAK.adoc[Vi(m) to Kakoune]</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;doc_gen/modules/ROOT/nav.adoc&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">nav_content</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      <p>Antora component description file.
See: https://docs.antora.org/antora/latest/component-version-descriptor.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">antora_yml_content</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">name: Kakoune</span>
<span class="s2">nav:</span>
<span class="s2">  - modules/ROOT/nav.adoc</span>
<span class="s2">title: Kakoune</span>
<span class="s2">version: latest</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;doc_gen/antora.yml&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">antora_yml_content</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      <p>Antora playbook file.
See: https://docs.antora.org/antora/latest/playbook.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">antora_playbook_content</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">asciidoc:</span>
<span class="s2">  attributes:</span>
<span class="s2">#DIVIDER</span>
<span class="s2">    attribute-missing: skip</span>
<span class="s2">#DIVIDER</span>
<span class="s2">    idprefix: &quot;&quot;</span>
<span class="s2">#DIVIDER</span>
<span class="s2">    idseparator: &quot;-&quot;</span>
<span class="s2">#DIVIDER</span>
<span class="s2">    reproducible: true</span>
<span class="s2">#DIVIDER</span>
<span class="s2">    sectids: true</span>
<span class="s2">#DIVIDER</span>
<span class="s2">    sectlinks: true</span>
<span class="s2">#DIVIDER</span>
<span class="s2">    sectnumlevels: 5</span>
<span class="s2">#DIVIDER</span>
<span class="s2">    sectnums: true</span>
<span class="s2">#DIVIDER</span>
<span class="s2">    toclevels: 5</span>

<span class="s2">  sourcemap: true</span>

<span class="s2">content:</span>
<span class="s2">  sources:</span>
<span class="s2">  - url: ./..</span>
<span class="s2">    start_path: doc_gen</span>
<span class="s2">    branches: [&quot;HEAD&quot;]</span>

<span class="s2">runtime:</span>
<span class="s2">  cache_dir: ./doc_gen/cache # More convenient for the development</span>
<span class="s2">  fetch: true # More convenient for the development</span>

<span class="s2">  log:</span>
<span class="s2">    failure_level: fatal</span>
<span class="s2">    level: warn</span>

<span class="s2">output:</span>
<span class="s2">  clean: true # More convenient for the development</span>
<span class="s2">  dir: ./build # Simpler to have it explicit in code</span>

<span class="s2">site:</span>
<span class="s2">  title: Kakoune Docs</span>

<span class="s2">ui:</span>
<span class="s2">  bundle:</span>
<span class="s2">    url: https://gitlab.com/antora/antora-ui-default/-/jobs/artifacts/HEAD/raw/build/ui-bundle.zip?job=bundle-stable</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;doc_gen/antora-playbook.yml&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">antora_playbook_content</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      <p>Do not complain on missing attributes,
TODO: fix and turn to a fatal warning</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">use_npx</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="s2">&quot;antora&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">shutil</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="s2">&quot;npx&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(([</span><span class="s2">&quot;npx&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">use_npx</span> <span class="k">else</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;antora&quot;</span><span class="p">,</span> <span class="s2">&quot;generate&quot;</span><span class="p">,</span> <span class="s2">&quot;doc_gen/antora-playbook.yml&quot;</span><span class="p">])</span>
<span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;xdg-open&quot;</span><span class="p">,</span> <span class="s2">&quot;./doc_gen/build/Kakoune/latest/index.html&quot;</span><span class="p">])</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      <p>To fix links</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      <p>To fix links</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      <p>Better to be reproducible, in general</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-23'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-23'>#</a>
      </div>
      <p>More convenient to turn sections to IDs</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-24'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-24'>#</a>
      </div>
      <p>More convenient to have sections as links</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-25'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-25'>#</a>
      </div>
      <p>Do not want to miss something</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-26'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-26'>#</a>
      </div>
      <p>More convenient to number the sections</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-27'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-27'>#</a>
      </div>
      <p>Do not want to miss something</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-28'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-28'>#</a>
      </div>
      <p>Finally, generate the documentation,
results will be saved to the output directory
as specified in the <code>antora-playbook.yml</code>.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
