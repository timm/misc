<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>push-to-checkout.sample</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div class='section'>
    <div class='docs'><h1>push-to-checkout.sample</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span></span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <p>An example hook script to update a checked-out tree on a git push.</p>
<p>This hook is invoked by git-receive-pack(1) when it reacts to git
push and updates reference(s) in its repository, and when the push
tries to update the branch that is currently checked out and the
receive.denyCurrentBranch configuration variable is set to
updateInstead.</p>
<p>By default, such a push is refused if the working tree and the index
of the remote repository has any difference from the currently
checked out commit; when both the working tree and the index match
the current commit, they are updated to match the newly pushed tip
of the branch. This hook is to be used to override the default
behaviour; however the code below reimplements the default behaviour
as a starting point for convenient modification.</p>
<p>The hook receives the commit with which the tip of the current
branch is going to be updated:</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nv">commit</span><span class="o">=</span><span class="nv">$1</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      <p>It can exit with a non-zero status to refuse the push (when it does
so, it must not modify the index or the working tree).</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>die<span class="w"> </span><span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">	</span><span class="nb">echo</span><span class="w"> </span>&gt;<span class="p">&amp;</span><span class="m">2</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$*</span><span class="s2">&quot;</span>
<span class="w">	</span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="o">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <p>Or it can make any necessary changes to the working tree and to the
index to bring them to the desired state when the tip of the current
branch is updated to the new commit, and exit with a zero status.</p>
<p>For example, the hook can simply run git read-tree -u -m HEAD &ldquo;$1&rdquo;
in order to emulate git fetch that is run in the reverse direction
with git push, as the two-tree form of git read-tree -u -m is
essentially the same as git switch or git checkout that switches
branches while keeping the local changes in the working tree that do
not interfere with the difference between the branches.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      <p>The below is a more-or-less exact translation to shell of the C code
for the default behaviour for git&rsquo;s push-to-checkout hook defined in
the push_to_deploy() function in builtin/receive-pack.c.</p>
<p>Note that the hook will be executed from the repository directory,
not from the working tree, so if you want to perform operations on
the working tree, you will have to adapt your code accordingly, e.g.
by adding &ldquo;cd ..&rdquo; or using relative paths.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">if</span><span class="w"> </span>!<span class="w"> </span>git<span class="w"> </span>update-index<span class="w"> </span>-q<span class="w"> </span>--ignore-submodules<span class="w"> </span>--refresh
<span class="k">then</span>
<span class="w">	</span>die<span class="w"> </span><span class="s2">&quot;Up-to-date check failed&quot;</span>
<span class="k">fi</span>

<span class="k">if</span><span class="w"> </span>!<span class="w"> </span>git<span class="w"> </span>diff-files<span class="w"> </span>--quiet<span class="w"> </span>--ignore-submodules<span class="w"> </span>--
<span class="k">then</span>
<span class="w">	</span>die<span class="w"> </span><span class="s2">&quot;Working directory has unstaged changes&quot;</span>
<span class="k">fi</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      <p>This is a rough translation of:</p>
<p>head_has_history() ? &ldquo;HEAD&rdquo; : EMPTY_TREE_SHA1_HEX</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">if</span><span class="w"> </span>git<span class="w"> </span>cat-file<span class="w"> </span>-e<span class="w"> </span>HEAD<span class="w"> </span><span class="m">2</span>&gt;/dev/null
<span class="k">then</span>
<span class="w">	</span><span class="nv">head</span><span class="o">=</span>HEAD
<span class="k">else</span>
<span class="w">	</span><span class="nv">head</span><span class="o">=</span><span class="k">$(</span>git<span class="w"> </span>hash-object<span class="w"> </span>-t<span class="w"> </span>tree<span class="w"> </span>--stdin<span class="w"> </span>&lt;/dev/null<span class="k">)</span>
<span class="k">fi</span>

<span class="k">if</span><span class="w"> </span>!<span class="w"> </span>git<span class="w"> </span>diff-index<span class="w"> </span>--quiet<span class="w"> </span>--cached<span class="w"> </span>--ignore-submodules<span class="w"> </span><span class="nv">$head</span><span class="w"> </span>--
<span class="k">then</span>
<span class="w">	</span>die<span class="w"> </span><span class="s2">&quot;Working directory has staged changes&quot;</span>
<span class="k">fi</span>

<span class="k">if</span><span class="w"> </span>!<span class="w"> </span>git<span class="w"> </span>read-tree<span class="w"> </span>-u<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$commit</span><span class="s2">&quot;</span>
<span class="k">then</span>
<span class="w">	</span>die<span class="w"> </span><span class="s2">&quot;Could not update working tree to new HEAD&quot;</span>
<span class="k">fi</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
